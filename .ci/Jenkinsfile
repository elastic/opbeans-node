#!/usr/bin/env groovy
@Library('apm@current') _

// Periodically check if there is an available newer APM agent version, e.g.
// "1.2.3". If so, then update to it and tag this repo with that version, e.g.
// "v1.2.3".
pipeline {
  agent { label 'linux && immutable' }
  environment {
    BASE_DIR = 'src/github.com/elastic'
    NOTIFY_TO = credentials('notify-to')
    PIPELINE_LOG_LEVEL = 'INFO'
    PATH = "${env.PATH}:${env.WORKSPACE}/bin"
    HOME = "${env.WORKSPACE}"
  }
  options {
    timeout(time: 10, unit: 'MINUTES')
    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))
    timestamps()
    ansiColor('xterm')
    disableResume()
    durabilityHint('PERFORMANCE_OPTIMIZED')
    rateLimitBuilds(throttle: [count: 60, durationName: 'hour', userBoost: true])
    quietPeriod(10)
    disableConcurrentBuilds(abortPrevious: isPR())
  }
  triggers {
    issueCommentTrigger('^/trent-test-trigger')
  }
  stages {
    stage('[XXX] Update APM Agent Dep') {
      steps {
        sh(script: 'pwd', label: 'XXX before')
        sh(script: 'ls')
        sh(script: 'git status')
        sh(script: 'git branch')
        sh(script: 'git config user.email')
        withGithubNotify(context: 'Update Agent Dep') {
          dir(BASE_DIR){
            deleteDir()
            git(
              credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',
              url: 'git@github.com:elastic/opbeans-node.git',
              branch: 'main'
            )
            sh(script: 'pwd', label: 'XXX after git checkout')
            sh(script: 'ls')
            sh(script: 'git status')
            sh(script: 'git branch')
            sh(script: 'git config user.email')
            script {
              AVAIL_AGENT_UPDATE_VER = sh(
                  script: '.ci/avail-agent-update-ver.sh',
                  returnStdout: true
              ).trim()
              if (AVAIL_AGENT_UPDATE_VER) {
                echo "Available agent version update: '${AVAIL_AGENT_UPDATE_VER}'"
                sh(script: ".ci/bump-version.sh ${AVAIL_AGENT_UPDATE_VER}")
                // gitPush()
                // gitCreateTag(tag: "v${AVAIL_AGENT_UPDATE_VER}")
              } else {
                echo "This repo is already using the latest available APM agent version."
              }
            }
          }
        }
      }
    }
  }
  post {
    always {
      notifyBuildResult()
    }
  }
}
